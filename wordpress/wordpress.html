

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin="">
</script>

<script src="https://www.google.com/recaptcha/api.js?render=captcha_token"></script>

<div class="header">
    <h2>
        Upload images and videos of the Lahaina fires
    </h2>
</div>

<div class="form">
    <form id="form" enctype="multipart/form-data">
        <div class="form-input">
            <h4>
                Email
            </h4>
            <input type="email" name="email" required>
        </div>
        <div class="form-input">
            <h4>
                Description
            </h4>
            <textarea id="description" type="text" name="description" required></textarea>
        </div>
        
        
        <div class="form-input">
            <div class="inline-input">
                <h4>
                    Latitude
                </h4>
                <input id="lat" type="number" step="0.000001" name="lat" required>
            </div>
            <div class="inline-input">
                <h4>
                    Longitude
                </h4>
                <input id="lng" type="number" step="0.000001" name="lng" required>
            </div>
            <h4>
                Click a location on the map to get its coordinates
            </h4>
            <div id="map"></div>
        </div>
        <div class="form-input file-upload">
            <h4>
                File
            </h4>
            <input type="file" name="file" accept="image/*, video/*" required>
        </div>
        <button type="submit">Upload</button>
    </form>

    <div id="submitMessage"></div>
</div>

<script>
    let southWest = L.latLng(20.805385510716093, -156.73919677734378);
    let northEast = L.latLng(20.933704959327144, -156.60186767578128);
    let bounds = L.latLngBounds(southWest, northEast);
    let map = L.map("map", {
        maxBounds: bounds,
        minZoom: 13,
        maxZoom: 20
    }).setView([20.871593978421544, -156.6777849197388], 18);
    L.tileLayer("http://www.google.com/maps/vt?lyrs=y@189&gl=en&x={x}&y={y}&z={z}", {
        maxZoom: 20
    }).addTo(map);
    map.on("click", (e) => {
        let {lat, lng} = e.latlng;
        //round to 6 decimals
        let precision = Math.pow(10, 6);
        lat = Math.round(lat * precision) / precision;
        lng = Math.round(lng * precision) / precision;
        document.getElementById("lat").value = lat;
        document.getElementById("lng").value = lng;
    });

    const form = document.getElementById("form");
    form.addEventListener("submit", formSubmit);
    const message = document.getElementById("submitMessage");

    function formSubmit(event) {
        event.preventDefault();

        grecaptcha.ready(function() {
            grecaptcha.execute("captcha_token", {action: "submit"}).then((token) => {
                message.innerHTML = "<hr> <h3>Your file is uploading...</h3>"
                let url = "http://149.165.154.247/upload";
                let request = new XMLHttpRequest();
                request.open("POST", url, true);
                // request.setRequestHeader("Content-Type", "multipart/form-data");
                request.onload = () => {
                    message.innerHTML = "<hr> <h3>Your file was successfully submitted. Thank you for your contribution!</h3>"
                };

                request.onerror = () => {
                    message.innerHTML = "<hr> <h3>An error occurred uploading your file. Please try a different file or try again later. If this error persists please contact the site administrators at hcdp@hawaii.edu.</h3>"
                };

                let formData = new FormData(form);
                
                request.send(formData);
                form.reset();
            });
        });
        
    }
</script>